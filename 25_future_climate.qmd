```{r set}
#| include: false
library(tidyverse)
```

# Future climate {.unnumbered}

> **Summary.** Future climate forcing from CMIP6 GCM between 1980 and 2100 under low emission scenarii SSP1-2.6 and high emission scenarii SSP5-8.5 [@neill2016]. Daily values were statistically downscaled on ERA5-Land historical data per month using cumulative distribution function transformation CDFt [@vrac2015]. Half-hourly values were downscaled using daily mean variations across years from ERA5-Land.

```{r assemble}
#| eval: false
library(ncdf4)
get_var <- function(file, var) {
  nc <- try(nc_open(file))
  if(!inherits(nc, "try-error")){
    data <- tibble(
      gcm = ncatt_get(nc, 0, "parent_source_id")$value,
      experiment = ncatt_get(nc, 0, "experiment_id")$value,
      date = as.character(as_date(ncatt_get(nc, "time", "units")$value) + 
                         ncvar_get(nc, "time")),
      "{var}" := as.numeric(ncvar_get(nc, var))
      ) 
    nc_close(nc)
    return(data)
  } else {
    warning(paste("Failed:", file))
    return(tibble())
  }
}
pr <- list.files("data/raw_data/cmip6/pr/", full.names = TRUE) %>% 
  lapply(get_var, "pr") %>% 
  bind_rows() %>% 
  mutate(pr = pr *60 * 60 * 24)
tas <- list.files("data/raw_data/cmip6/tas/", full.names = TRUE) %>%
  lapply(get_var, "tas") %>%
  bind_rows() %>%
  mutate(tas = tas - 273.15)
pr %>%  
  full_join(tas) %>% 
  filter(paste(month(date), day(date)) != "2 29") %>% 
  arrange(gcm, experiment, date) %>% 
  write_tsv("data/derived_data/projections_raw.tsv")
```

```{r bias-correct}
#| eval: false
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  gather(variable, value, -date) %>% 
  na.omit() %>% 
  group_by(variable, date = as_date(date)) %>%
  mutate(value = ifelse(variable %in% c("pr", "snet"), sum(value), value)) %>% 
  summarise(era = mean(value)) %>% 
  ungroup()
proj <- read_tsv("data/derived_data/projections_raw.tsv") %>% 
  gather(variable, value, -date, -gcm, -experiment)
apply_bc <- function(model, month, var, era, proj){
  era_sub <- era %>% 
    filter(variable == var, month(date) ==  month)
  proj_sub <- proj %>%
    filter(gcm == model, variable == var, month(date) ==  month) %>%
    left_join(era_sub)
  train <- filter(proj_sub, !is.na(era))
  adjusted <- CDFt::CDFt(
    ObsRp = train$era,
    DataGp = train$value,
    DataGf = proj_sub$value
  )
  proj_sub %>%
    mutate(value = adjusted$DS) %>%
    select(-era)
}
bc <- expand_grid(
  gcm = unique(read_tsv("data/derived_data/projections_raw.tsv")$gcm),
  month = 1:12,
  var = "pr"
) %>% 
  rowwise() %>% 
  mutate(bc = list(apply_bc(gcm, month, var, era, proj))) 
bc %>% 
  unnest() %>% 
  select(-gcm1, -var, -month) %>% 
  pivot_wider(names_from = variable, values_from = value) %>% 
  arrange(gcm, experiment, date) %>% 
  write_tsv("data/derived_data/projections.tsv")
```

## Precipitation

CMIP6 raw precipitation projections mostly underestimated annual precipitation with lower monthly values and unrealistic seasonal pattern showing lagged and more intense dry seasons for all GCMs. After bias-correction we obtained more realistic annual precipitation, good monthly precipitation correlations to ERA5-Land above 0.6 and a realistic seasonality with the June to November dry season below 100-mm. Bias-correction using cumulative distribution function was applied on absolute precipitation value but might be improved considering relative daily precipitation volume in the month.

```{r pr_an_raw}
#| message: false
#| warning: false
#| fig-cap: "Annual CMIP6 raw precipitation projections for scenarii SSP1-2.6 and SSP5-8.5 compared to ERA5-Land reanalysis (black)."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "year"))) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  mutate(gcm = "ERA5-Land", experiment = "historical")
read_tsv("data/derived_data/projections_raw.tsv") %>% 
  group_by(gcm, experiment, date = floor_date(date, "year")) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  ggplot(aes(date, pr, group = paste(gcm, experiment), col = gcm)) +
  geom_line() +
  geom_line(data = era, col = "black") +
  theme_bw() +
  xlab("") + ylab("Precipitation [ mm ]") +
  scale_color_discrete("")
```

```{r pr_mon_raw}
#| message: false
#| warning: false
#| fig-cap: "Evaluations of CMIP6 raw projections monthly precipitations against ERA5-Land."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "month"))) %>% 
  summarise(era = sum(pr, na.rm = TRUE))
read_tsv("data/derived_data/projections_raw.tsv") %>% 
  group_by(gcm, experiment, date = floor_date(date, "month")) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  left_join(era) %>% 
  ggplot(aes(era, pr, col = gcm)) +
  geom_abline() +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  ggpubr::stat_cor() +
  scale_color_discrete("") +
  ggtitle("Monthly total precipitation [ mm ]") +
  xlab("ERA5-Land") + ylab("CMIP6 GCM raw projection")
```

```{r pr_seas_raw}
#| message: false
#| warning: false
#| fig-cap: "Seasonal CMIP6 raw precipitation projections for scenarii SSP1-2.6 and SSP5-8.5 compared to ERA5-Land reanalysis (black)."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "month"))) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  mutate(gcm = "ERA5-Land") %>% 
  group_by(gcm, date = month(date)) %>% 
  summarise(pr = mean(pr))
read_tsv("data/derived_data/projections_raw.tsv") %>% 
  filter(experiment == "historical") %>% 
  group_by(gcm, date = floor_date(date, "month")) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  group_by(gcm, date = month(date)) %>% 
  summarise(pr = mean(pr)) %>% 
  ggplot(aes(date, pr, col = gcm)) +
  geom_line() +
  geom_line(data = era, col = "black") +
  theme_bw() +
  xlab("") + ylab("Precipitation [ mm ]") +
  scale_color_discrete("") +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
```

```{r pr_an_bc}
#| message: false
#| warning: false
#| fig-cap: "Annual CMIP6 bias-corrected precipitation projections for scenarii SSP1-2.6 and SSP5-8.5 compared to ERA5-Land reanalysis (black)."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "year"))) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  mutate(gcm = "ERA5-Land", experiment = "historical")
read_tsv("data/derived_data/projections.tsv") %>% 
  group_by(gcm, experiment, date = floor_date(date, "year")) %>% 
  summarise(pr = sum(pr)) %>% 
  ggplot(aes(date, pr, group = paste(gcm, experiment), col = gcm)) +
  geom_line() +
  geom_line(data = era, col = "black") +
  theme_bw() +
  xlab("") + ylab("Precipitation [ mm ]") +
  scale_color_discrete("") +
  theme(legend.key.size = unit(.8, "line"))
```

```{r pr_mon_bc}
#| message: false
#| warning: false
#| fig-cap: "Evaluations of CMIP6 bias-corrected projections monthly precipitations against ERA5-Land."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "month"))) %>% 
  summarise(era = sum(pr, na.rm = TRUE))
read_tsv("data/derived_data/projections.tsv") %>% 
  group_by(gcm, experiment, date = floor_date(date, "month")) %>% 
  summarise(pr = sum(pr)) %>% 
  left_join(era) %>% 
  ggplot(aes(era, pr, col = gcm)) +
  geom_abline() +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  ggpubr::stat_cor() +
  scale_color_discrete("") +
  ggtitle("Monthly total precipitation [ mm ]") +
  xlab("ERA5-Land") + ylab("CMIP6 GCM raw projection")
```

```{r pr_seas_bc}
#| message: false
#| warning: false
#| fig-cap: "Seasonal CMIP6 bias-corrected precipitation projections for scenarii SSP1-2.6 and SSP5-8.5 compared to ERA5-Land reanalysis (black)."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "month"))) %>% 
  summarise(pr = sum(pr, na.rm = TRUE)) %>% 
  mutate(gcm = "ERA5-Land") %>% 
  group_by(gcm, date = month(date)) %>% 
  summarise(pr = mean(pr))
read_tsv("data/derived_data/projections.tsv") %>% 
  filter(experiment == "historical") %>% 
  group_by(gcm, date = floor_date(date, "month")) %>% 
  summarise(pr = sum(pr)) %>% 
  group_by(gcm, date = month(date)) %>% 
  summarise(pr = mean(pr)) %>% 
  ggplot(aes(date, pr, col = gcm)) +
  geom_line() +
  geom_line(data = era, col = "black") +
  theme_bw() +
  xlab("") + ylab("Precipitation [ mm ]") +
  scale_color_discrete("") +
  scale_x_continuous(breaks = 1:12,
                     labels = c("J", "F", "M", "A", "M", "J", "J", "A",
                                "S", "O", "N", "D"))
```

## Temperature

*ToDo from tas.*

```{r tas_an_raw}
#| message: false
#| warning: false
#| fig-cap: "Annual CMIP6 mean temperature projections for scenarii SSP1-2.6 and SSP5-8.5 compared to ERA5-Land reanalysis (black)."
era <- read_tsv("data/derived_data/climate.tsv") %>% 
  group_by(date = as_date(floor_date(date, "year"))) %>% 
  summarise(tas = mean(tas, na.rm = TRUE)) %>% 
  mutate(gcm = "ERA5-Land", experiment = "historical")
read_tsv("data/derived_data/projections_raw.tsv") %>% 
  group_by(gcm, experiment, date = floor_date(date, "year")) %>% 
  summarise(tas = mean(tas, na.rm = TRUE)) %>% 
  ggplot(aes(date, tas, group = paste(gcm, experiment), col = gcm)) +
  geom_line() +
  geom_line(data = era, col = "black") +
  theme_bw() +
  xlab("") + ylab("Temperature [ Â°C ]") +
  scale_color_discrete("")
```

## Wind speed

*ToDo from ws=sqrt(uas\^2+vas\^2).*

## Vapour pressure deficit

*ToDo from vpd=f(huss).*

## Radiations

*ToDo from snet=rsdus-rsus.*

## Half-hourly downscaling

*ToDo using each day half-hourly mean variation across years.*

```{r}
#| message: false
#| warning: false
#| fig-cap: "Half-hourly relative variation across 45 years from the first day of the month"
read_tsv("data/derived_data/climate.tsv") %>% 
  select(-pr) %>% 
  gather(variable, value, -date) %>% 
  filter(day(date) == 1) %>% 
  mutate(time = minute(date)+60*hour(date),
         month = month(date)) %>% 
  group_by(variable, date2 = as_date(date)) %>% 
  mutate(value = value/mean(value)) %>% 
  select(-date2) %>% 
  group_by(variable, month, time) %>% 
  summarise(l = quantile(value, .05),
            m  = quantile(value, .5),
            h  = quantile(value, .95)) %>% 
  ggplot(aes(time/60, m)) +
  geom_ribbon(aes(ymin = l, ymax= h), fill = "lightgrey", col = NA) +
  geom_line() +
  facet_grid(variable ~ month, scales = "free") +
  theme_bw() +
  xlab("") + ylab("") +
  theme(axis.text.x = element_text(angle = 90))
```
